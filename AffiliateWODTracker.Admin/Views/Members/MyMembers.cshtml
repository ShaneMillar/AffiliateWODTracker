@using AffiliateWODTracker.Core.ViewModels
@model List<MemberViewModel>

@functions {
    public static int CalculateAge(DateTime dateOfBirth)
    {
        var today = DateTime.Today;
        var age = today.Year - dateOfBirth.Year;
        if (dateOfBirth.Date > today.AddYears(-age)) age--;
        return age;
    }
}

@if (Model != null && Model.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Address</th>
                <th>Age</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var member in Model)
            {
                <tr>
                    <td>@member.FirstName @member.LastName</td>
                    <td>@member.Email</td>
                    <td>@member.PhoneNumber</td>
                    <td>@member.Address</td>
                    <td>@CalculateAge(member.DateOfBirth)</td>
                    <td>
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#removeConfirmationModal" data-memberid="@member.MemberId">
                            Remove
                        </button>

                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="text-center">
    <p>There are no active members in this affiliate.</p>
      <a asp-controller="Members" asp-action="MyRequests" class="btn btn-custom">Incoming Requests</a>
    </div>
}

<div class="modal fade" id="removeConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="removeConfirmationModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeConfirmationModalLabel">Remove Member</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you wish to Remove this member from your Affiliate (You can accept them again in Pending Requests)?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                <!-- The confirm button now calls handleMemberRemoval without an ID -->
                <button type="button" class="btn btn-danger" id="confirmRemoveButton">Yes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // This function will be called with the correct memberId when the remove button is clicked
        function handleMemberRemoval(memberId) {
            var removeUrl = '/Members/RemoveMember';
            fetch(removeUrl, {
                method: 'PUT', // Make sure your endpoint accepts PUT requests
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ memberId: memberId })
            })
                .then(response => {
                    if (response.ok) {
                        location.reload(); // Or use JavaScript to remove the row from the DOM
                    } else {
                        console.error('Removal failed.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        $(document).ready(function () {
            // Bind to the show event of the modal
            $('#removeConfirmationModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Button that triggered the modal
                var memberId = button.data('memberid'); // Extract info from data-* attributes

                // When the confirm button is clicked, call handleMemberRemoval with the memberId
                $(this).find('.btn-danger').off('click').on('click', function () {
                    handleMemberRemoval(memberId);
                });
            });
        });
    </script>
}
